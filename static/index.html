<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CG1618 Anime Site</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Roboto", "Noto Sans TC", "sans-serif"],
            },
            colors: {
              brand: {
                DEFAULT: "#6366f1", // Indigo 500
                hover: "#4f46e5", // Indigo 600
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Custom scrollbar for dark mode */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      /* Smooth transitions */
      .card-hover {
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col font-sans">
    <!-- Top Navigation Bar -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo & Links -->
          <div class="flex items-center space-x-8">
            <div
              class="flex-shrink-0 font-bold text-2xl tracking-wider text-brand"
            >
              CG1618
            </div>
            <div class="hidden md:block">
              <div class="flex items-baseline space-x-4">
                <a
                  href="#"
                  class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium"
                  >Dashboard</a
                >
                <a
                  href="#"
                  class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition"
                  >Library</a
                >
                <a
                  href="#"
                  class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition"
                  >Admin</a
                >
              </div>
            </div>
          </div>

          <!-- Search & Sync -->
          <div class="flex items-center space-x-4 flex-1 justify-end">
            <div class="relative w-full max-w-md hidden sm:block">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-search text-gray-400"></i>
              </div>
              <input
                type="text"
                class="block w-full pl-10 pr-3 py-2 border border-gray-600 rounded-md leading-5 bg-gray-700 text-gray-300 placeholder-gray-400 focus:outline-none focus:bg-gray-600 focus:border-brand focus:ring-1 focus:ring-brand sm:text-sm transition"
                placeholder="Search English, Romaji, or 中文..."
              />
            </div>

            <button
              onclick="handleSync()"
              id="syncBtn"
              class="bg-brand hover:bg-brand-hover text-white px-4 py-2 rounded-md text-sm font-medium flex items-center transition"
            >
              <i class="fas fa-sync-alt mr-2" id="syncIcon"></i> Sync Sheets
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">
          <i class="fas fa-play-circle text-brand mr-2"></i> Active Watching
        </h1>
        <span
          class="text-sm text-gray-400 bg-gray-800 px-3 py-1 rounded-full"
          id="activeCount"
          >0 Shows</span
        >
      </div>

      <!-- Anime Grid -->
      <div
        id="animeGrid"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
      >
        <!-- Cards will be injected here by JavaScript -->
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 mt-auto">
      <div
        class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-center text-sm text-gray-400"
      >
        &copy; 2026 CG1618 Anime Database. Version 1.0
      </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
      // Changed to a relative path! This works on localhost AND in the cloud.
      const API_BASE_URL = "/api";
      let animeData = [];

      // 1. Fetch real data from your FastAPI backend
      async function fetchAnime() {
        try {
          const response = await fetch(`${API_BASE_URL}/anime`);
          const allAnime = await response.json();

          // Filter to only show active watching on the Home Dashboard
          animeData = allAnime.filter(
            (a) => a.my_progress === "Active Watching",
          );

          renderCards();
        } catch (error) {
          console.error("Failed to fetch anime:", error);
          document.getElementById("animeGrid").innerHTML = `
                    <div class="col-span-full text-center text-red-400 py-8 bg-gray-800 rounded-xl border border-red-500/20">
                        <i class="fas fa-exclamation-triangle mb-2 text-2xl"></i>
                        <p>Error loading data. Is your FastAPI server running?</p>
                    </div>`;
        }
      }

      // 2. Render the cards using actual database schema names
      function renderCards() {
        const grid = document.getElementById("animeGrid");
        grid.innerHTML = ""; // Clear current grid

        document.getElementById("activeCount").innerText =
          `${animeData.length} Shows`;

        animeData.forEach((anime) => {
          // Determine Ranking Color based on your 'rating_mine' column
          let rankColor = "bg-gray-700 text-gray-300";
          if (anime.rating_mine === "S")
            rankColor =
              "bg-yellow-500/20 text-yellow-400 border border-yellow-500/50";
          if (anime.rating_mine === "A")
            rankColor = "bg-red-500/20 text-red-400 border border-red-500/50";
          if (anime.rating_mine === "B")
            rankColor =
              "bg-blue-500/20 text-blue-400 border border-blue-500/50";

          const totalEps = anime.ep_total ? anime.ep_total : "?";
          const progressPercent = anime.ep_total
            ? Math.round((anime.ep_fin / anime.ep_total) * 100)
            : 0;

          // Fallback title logic (use season title if available, else series title)
          const mainTitle =
            anime.series_season_en || anime.series_en || "Unknown Title";
          const subTitle = anime.series_season_cn || anime.series_cn || "";

          const cardHTML = `
                    <div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700 flex flex-col card-hover">
                        <!-- Key Visual Image -->
                        <div class="h-48 w-full relative bg-gray-700">
                            <img src="${anime.cover_image_url || ""}" alt="${mainTitle}" class="w-full h-full object-cover object-top" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100%\\' height=\\'100%\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'%23374151\\'/><text x=\\'50%\\' y=\\'50%\\' font-family=\\'Arial\\' font-size=\\'14\\' fill=\\'%239CA3AF\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\'>No Image Available</text></svg>'">
                            <div class="absolute top-2 right-2 ${rankColor} text-xs font-bold px-2 py-1 rounded shadow-lg backdrop-blur-sm">
                                Tier: ${anime.rating_mine || "-"}
                            </div>
                            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-gray-900 to-transparent p-3 pt-8">
                                <span class="text-xs font-semibold text-brand bg-gray-900/80 px-2 py-0.5 rounded">${anime.release_date || "TBA"}</span>
                            </div>
                        </div>

                        <!-- Card Content -->
                        <div class="p-4 flex-1 flex flex-col">
                            <h2 class="text-lg font-bold text-white line-clamp-1 mb-1" title="${mainTitle}">${mainTitle}</h2>
                            <h3 class="text-sm text-gray-400 line-clamp-1 mb-3 font-medium" title="${subTitle}">${subTitle}</h3>
                            
                            <div class="space-y-2 text-sm text-gray-300 mb-4 bg-gray-900/50 p-3 rounded-lg border border-gray-700/50 flex-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Studio:</span>
                                    <span class="font-medium truncate ml-2">${anime.studio || "-"}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Status:</span>
                                    <span class="text-xs ${anime.airing_status === "Currently Airing" ? "text-green-400 bg-green-400/10" : "text-blue-400 bg-blue-400/10"} px-2 py-0.5 rounded border ${anime.airing_status === "Currently Airing" ? "border-green-400/20" : "border-blue-400/20"}">
                                        ${anime.airing_status || "-"}
                                    </span>
                                </div>
                            </div>

                            <!-- Episode Tracker Component -->
                            <div class="mt-auto">
                                <div class="text-xs text-gray-400 mb-1 flex justify-between">
                                    <span>Episodes Watched</span>
                                    <span>${progressPercent}%</span>
                                </div>
                                
                                <div class="w-full bg-gray-700 rounded-full h-1.5 mb-3">
                                    <div class="bg-brand h-1.5 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>

                                <div class="flex items-center justify-between bg-gray-900 rounded-lg p-1 border border-gray-700">
                                    <button onclick="updateProgress('${anime.system_id}', -1)" class="w-8 h-8 rounded-md hover:bg-gray-700 text-gray-400 hover:text-white transition flex items-center justify-center">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    
                                    <div class="font-mono font-bold text-lg tracking-wide">
                                        <span class="text-white">${anime.ep_fin || 0}</span>
                                        <span class="text-gray-500 mx-1">/</span>
                                        <span class="text-gray-400">${totalEps}</span>
                                    </div>
                                    
                                    <button onclick="updateProgress('${anime.system_id}', 1)" class="w-8 h-8 rounded-md bg-brand/10 hover:bg-brand text-brand hover:text-white transition flex items-center justify-center">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          grid.innerHTML += cardHTML;
        });
      }

      // 3. Logic for the +/- buttons (Sends real PATCH request)
      async function updateProgress(system_id, change) {
        const index = animeData.findIndex((a) => a.system_id === system_id);
        if (index === -1) return;

        let current = animeData[index].ep_fin || 0;
        let total = animeData[index].ep_total;
        let newTotal = current;

        if (change < 0 && current > 0) {
          newTotal--;
        } else if (change > 0 && (!total || current < total)) {
          newTotal++;
        } else {
          return; // No change needed
        }

        // Optimistically update the UI instantly
        animeData[index].ep_fin = newTotal;
        renderCards();

        // Send request to backend to update DB and Google Sheets
        try {
          const response = await fetch(
            `${API_BASE_URL}/anime/${system_id}/progress`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ep_fin: newTotal }),
            },
          );

          if (!response.ok) {
            throw new Error("Failed to update on server");
          }
        } catch (error) {
          console.error("Error updating progress:", error);
          alert(
            "Failed to sync progress to database. Please check connection.",
          );
          // Revert UI if it failed
          animeData[index].ep_fin = current;
          renderCards();
        }
      }

      // 4. Logic for the Sync Button (Sends real POST request)
      async function handleSync() {
        const icon = document.getElementById("syncIcon");
        const btn = document.getElementById("syncBtn");

        icon.classList.add("fa-spin");
        btn.classList.add("opacity-75");
        btn.innerText = " Syncing...";
        btn.prepend(icon);

        try {
          const response = await fetch(`${API_BASE_URL}/sync`, {
            method: "POST",
          });
          const result = await response.json();

          if (response.ok) {
            // Refetch data from DB so UI updates with new Google Sheet rows
            await fetchAnime();
          } else {
            alert(`Sync Error: ${result.detail}`);
          }
        } catch (error) {
          alert("Failed to connect to the backend sync service.");
          console.error(error);
        } finally {
          icon.classList.remove("fa-spin");
          btn.classList.remove("opacity-75");
          btn.innerText = " Sync Sheets";
          btn.prepend(icon);
        }
      }

      // Initialize the app on page load
      document.addEventListener("DOMContentLoaded", () => {
        fetchAnime();
      });
    </script>
  </body>
</html>
