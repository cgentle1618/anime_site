<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CG1618 Anime Site</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class", // Kept for future system theme support
        theme: {
          extend: {
            fontFamily: {
              sans: ["Roboto", "Noto Sans TC", "sans-serif"],
            },
            colors: {
              brand: {
                DEFAULT: "#6366f1", // Indigo 500
                hover: "#4f46e5", // Indigo 600
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Custom scrollbar for light mode */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f3f4f6;
      }
      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      /* Smooth transitions */
      .card-hover {
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      /* Hide number input arrows */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col font-sans">
    <!-- Top Navigation Bar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo & Links -->
          <div class="flex items-center space-x-8">
            <div
              class="flex-shrink-0 font-bold text-2xl tracking-wider text-brand"
            >
              CG1618
            </div>
            <div class="hidden md:block">
              <div class="flex items-baseline space-x-4">
                <a
                  href="/"
                  class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium"
                  >Dashboard</a
                >
                <a
                  href="/library"
                  class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition"
                  >Library</a
                >
                <a
                  href="/admin"
                  class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition"
                  >Admin</a
                >
              </div>
            </div>
          </div>

          <!-- Search & Sync -->
          <div class="flex items-center space-x-4 flex-1 justify-end">
            <div class="relative w-full max-w-md hidden sm:block">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-search text-gray-400"></i>
              </div>
              <input
                type="text"
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-brand focus:border-brand sm:text-sm transition"
                placeholder="Search English, Romaji, or 中文..."
              />
            </div>

            <button
              onclick="handleSync()"
              id="syncBtn"
              class="bg-brand hover:bg-brand-hover text-white px-4 py-2 rounded-md text-sm font-medium flex items-center transition shadow-sm"
            >
              <i class="fas fa-sync-alt mr-2" id="syncIcon"></i> Sync Sheets
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
      <!-- SECTION 1: Active Watching -->
      <div id="activeSection" class="mb-12">
        <!-- STICKY HEADER -->
        <div
          class="sticky top-16 z-40 bg-gray-50/95 backdrop-blur-sm py-4 mb-4 flex justify-between items-center border-b border-gray-200"
        >
          <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-play-circle text-brand mr-2"></i> Active Watching
          </h1>
          <span
            class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full border border-gray-200 shadow-sm"
            id="activeCount"
            >0 Shows</span
          >
        </div>
        <div id="activeGrid" class="flex flex-col gap-4">
          <!-- Cards injected via JS -->
        </div>
      </div>

      <!-- SECTION 2: Passive Watching -->
      <div id="passiveSection" class="mb-12">
        <!-- STICKY HEADER -->
        <div
          class="sticky top-16 z-40 bg-gray-50/95 backdrop-blur-sm py-4 mb-4 flex justify-between items-center border-b border-gray-200"
        >
          <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-coffee text-brand mr-2"></i> Passive Watching
          </h1>
          <span
            class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full border border-gray-200 shadow-sm"
            id="passiveCount"
            >0 Shows</span
          >
        </div>
        <div id="passiveGrid" class="flex flex-col gap-4">
          <!-- Cards injected via JS -->
        </div>
      </div>

      <!-- SECTION 3: Paused -->
      <div id="pausedSection" class="mb-12">
        <!-- STICKY HEADER -->
        <div
          class="sticky top-16 z-40 bg-gray-50/95 backdrop-blur-sm py-4 mb-4 flex justify-between items-center border-b border-gray-200"
        >
          <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-pause-circle text-brand mr-2"></i> Paused
          </h1>
          <span
            class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full border border-gray-200 shadow-sm"
            id="pausedCount"
            >0 Shows</span
          >
        </div>
        <div id="pausedGrid" class="flex flex-col gap-4">
          <!-- Cards injected via JS -->
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
      <div
        class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8 flex justify-center text-sm text-gray-500"
      >
        &copy; 2026 CG1618 Anime Database. Version 1.0
      </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
      const API_BASE_URL = "/api";
      let animeData = [];

      // Definition of Tier Hierarchy
      const tierOrder = {
        S: 1,
        "A+": 2,
        A: 3,
        B: 4,
        C: 5,
        D: 6,
        E: 7,
        F: 8,
      };

      // Custom sorting function based on tier
      function sortByTier(a, b) {
        const rankA = tierOrder[a.rating_mine] || 99;
        const rankB = tierOrder[b.rating_mine] || 99;
        return rankA - rankB;
      }

      // 1. Fetch real data from your FastAPI backend
      async function fetchAnime() {
        try {
          const response = await fetch(`${API_BASE_URL}/anime`);
          const allAnime = await response.json();

          animeData = allAnime.filter(
            (a) =>
              a.my_progress === "Active Watching" ||
              a.my_progress === "Passive Watching" ||
              a.my_progress === "Paused",
          );

          renderCards();
        } catch (error) {
          console.error("Failed to fetch anime:", error);
          document.getElementById("activeSection").style.display = "block";
          document.getElementById("activeGrid").innerHTML = `
                    <div class="w-full text-center text-red-600 py-8 bg-red-50 rounded-xl border border-red-200">
                        <i class="fas fa-exclamation-triangle mb-2 text-2xl"></i>
                        <p>Error loading data. Is your FastAPI server running?</p>
                    </div>`;
        }
      }

      // Helper function to generate the HTML for a single Anime Card
      function createCardHTML(anime) {
        // Default styling for no tier (Light Mode)
        let rankColor = "bg-gray-100 text-gray-600 border-gray-300";

        // Expanded Tier Color Logic for Light Mode
        if (anime.rating_mine === "S")
          rankColor = "bg-yellow-100 text-yellow-700 border border-yellow-300";
        else if (anime.rating_mine === "A+")
          rankColor = "bg-orange-100 text-orange-700 border border-orange-300";
        else if (anime.rating_mine === "A")
          rankColor = "bg-red-100 text-red-700 border border-red-300";
        else if (anime.rating_mine === "B")
          rankColor = "bg-blue-100 text-blue-700 border border-blue-300";
        else if (anime.rating_mine === "C")
          rankColor = "bg-green-100 text-green-700 border border-green-300";
        else if (anime.rating_mine === "D")
          rankColor = "bg-teal-100 text-teal-700 border border-teal-300";
        else if (anime.rating_mine === "E")
          rankColor = "bg-purple-100 text-purple-700 border border-purple-300";
        else if (anime.rating_mine === "F")
          rankColor = "bg-gray-200 text-gray-700 border border-gray-300";

        const totalEps = anime.ep_total ? anime.ep_total : "?";
        const progressPercent = anime.ep_total
          ? Math.round((anime.ep_fin / anime.ep_total) * 100)
          : 0;

        // Title logic: Use series_season_cn. Do NOT fall back to series_cn.
        let mainTitle = anime.series_season_cn;
        let subTitle = anime.series_season_en || anime.series_en || "";

        // If series_season_cn is not available, use English and hide subtitle.
        if (!mainTitle) {
          mainTitle =
            anime.series_season_en || anime.series_en || "Unknown Title";
          subTitle = "";
        }

        return `
                <div class="bg-white rounded-xl overflow-hidden border border-gray-200 flex flex-col sm:flex-row card-hover shadow-sm">
                    <!-- Key Visual Image -->
                    <div class="h-48 sm:h-auto sm:w-48 relative bg-gray-200 shrink-0 border-r border-gray-100">
                        <img src="${anime.cover_image_url || ""}" alt="${mainTitle}" class="w-full h-full object-cover object-top" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100%\\' height=\\'100%\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'%23E5E7EB\\'/><text x=\\'50%\\' y=\\'50%\\' font-family=\\'Arial\\' font-size=\\'14\\' fill=\\'%236B7280\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\'>No Image</text></svg>'">
                        <div class="absolute top-2 left-2 ${rankColor} text-xs font-bold px-2 py-1 rounded shadow-sm backdrop-blur-sm">
                            Tier: ${anime.rating_mine || "-"}
                        </div>
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent p-2 pt-8">
                            <span class="text-xs font-semibold text-white bg-black/60 px-2 py-0.5 rounded shadow-sm">${anime.release_date || "TBA"}</span>
                        </div>
                    </div>

                    <!-- Row Content -->
                    <div class="p-4 flex-1 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        
                        <!-- Left Info Section -->
                        <div class="flex-1 min-w-0">
                            <h2 class="text-lg font-bold text-gray-900 line-clamp-1 mb-1" title="${mainTitle}">${mainTitle}</h2>
                            <h3 class="text-sm text-gray-500 line-clamp-1 mb-3 font-medium" title="${subTitle}">${subTitle}</h3>
                            
                            <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                                <span class="text-xs ${anime.airing_status === "Currently Airing" ? "text-green-700 bg-green-100 border-green-200" : "text-blue-700 bg-blue-100 border-blue-200"} px-2 py-1 rounded border shadow-sm">
                                    ${anime.airing_status || "-"}
                                </span>
                                <span class="bg-gray-100 px-2 py-1 rounded-md border border-gray-200 flex items-center shadow-sm">
                                    <i class="fas fa-building text-gray-400 mr-2 text-xs"></i>
                                    <span class="truncate max-w-[120px]" title="${anime.studio || "-"}">${anime.studio || "-"}</span>
                                </span>
                            </div>
                        </div>

                        <!-- Right Tracker Component -->
                        <div class="w-full sm:w-64 bg-gray-50 p-3 rounded-xl border border-gray-200 shrink-0">
                            <div class="text-xs text-gray-500 mb-2 flex justify-between items-center">
                                <span>Episodes Watched</span>
                                <span class="font-bold text-gray-900">${progressPercent}%</span>
                            </div>
                            
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-3">
                                <div class="bg-brand h-1.5 rounded-full transition-all duration-300 shadow-sm" style="width: ${progressPercent}%"></div>
                            </div>

                            <div class="flex items-center justify-between bg-white rounded-lg p-1 border border-gray-200 shadow-sm">
                                <button onclick="updateProgress('${anime.system_id}', -1)" class="w-8 h-8 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-900 transition flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                
                                <div class="font-mono font-bold text-lg tracking-wide flex items-baseline justify-center">
                                    <input type="number" 
                                           value="${anime.ep_fin || 0}" 
                                           onchange="setExactProgress('${anime.system_id}', this.value)"
                                           onclick="this.select()"
                                           class="w-12 text-center text-gray-900 bg-transparent border-b-2 border-transparent hover:border-gray-300 focus:border-brand focus:outline-none transition-colors appearance-none p-0" />
                                    <span class="text-gray-400 mx-1 text-sm">/</span>
                                    <span class="text-gray-500 text-sm">${totalEps}</span>
                                </div>
                                
                                <button onclick="updateProgress('${anime.system_id}', 1)" class="w-8 h-8 rounded-md bg-brand/10 hover:bg-brand text-brand hover:text-white transition flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      }

      // Helper function to inject cards into a specific section
      function renderSection(filteredData, gridId, countId, sectionId) {
        const grid = document.getElementById(gridId);
        const section = document.getElementById(sectionId);
        grid.innerHTML = ""; // Clear previous

        // DYNAMIC UI: If a section has 0 anime, hide the entire section completely.
        if (filteredData.length === 0) {
          section.style.display = "none";
          return;
        }

        // Otherwise, show the section and render the cards
        section.style.display = "block";
        document.getElementById(countId).innerText =
          `${filteredData.length} Shows`;

        filteredData.forEach((anime) => {
          grid.innerHTML += createCardHTML(anime);
        });
      }

      // 2. Render all the cards into their respective sections
      function renderCards() {
        const active = animeData
          .filter((a) => a.my_progress === "Active Watching")
          .sort(sortByTier);
        const passive = animeData
          .filter((a) => a.my_progress === "Passive Watching")
          .sort(sortByTier);
        const paused = animeData
          .filter((a) => a.my_progress === "Paused")
          .sort(sortByTier);

        // Passing the wrapper ID (e.g. 'activeSection') so we can hide/show it dynamically
        renderSection(active, "activeGrid", "activeCount", "activeSection");
        renderSection(passive, "passiveGrid", "passiveCount", "passiveSection");
        renderSection(paused, "pausedGrid", "pausedCount", "pausedSection");
      }

      // Logic for the +/- buttons
      function updateProgress(system_id, change) {
        const index = animeData.findIndex((a) => a.system_id === system_id);
        if (index === -1) return;

        let current = animeData[index].ep_fin || 0;
        let newTotal = current + change;

        // Pass the new calculated value directly to our existing logic!
        setExactProgress(system_id, newTotal);
      }

      // 3. Logic for exact progress input (Sends real PATCH request)
      async function setExactProgress(system_id, newValue) {
        const index = animeData.findIndex((a) => a.system_id === system_id);
        if (index === -1) return;

        let parsedValue = parseInt(newValue, 10);
        if (isNaN(parsedValue)) parsedValue = 0;

        let total = animeData[index].ep_total;

        // Prevent going below 0 or above total episode count
        if (parsedValue < 0) parsedValue = 0;
        if (total && parsedValue > total) parsedValue = total;

        const current = animeData[index].ep_fin || 0;
        if (parsedValue === current) {
          renderCards(); // Re-render to clear invalid typing in the UI
          return;
        }

        // Optimistically update the UI instantly
        animeData[index].ep_fin = parsedValue;
        renderCards();

        // Send request to backend to update DB and Google Sheets
        try {
          const response = await fetch(
            `${API_BASE_URL}/anime/${system_id}/progress`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ep_fin: parsedValue }),
            },
          );

          if (!response.ok) {
            throw new Error("Failed to update on server");
          }
        } catch (error) {
          console.error("Error updating progress:", error);
          alert(
            "Failed to sync progress to database. Please check connection.",
          );
          // Revert UI if it failed
          animeData[index].ep_fin = current;
          renderCards();
        }
      }

      // 4. Logic for the Sync Button (Sends real POST request)
      async function handleSync() {
        const icon = document.getElementById("syncIcon");
        const btn = document.getElementById("syncBtn");

        icon.classList.add("fa-spin");
        btn.classList.add("opacity-75");
        btn.innerText = " Syncing...";
        btn.prepend(icon);

        try {
          const response = await fetch(`${API_BASE_URL}/sync`, {
            method: "POST",
          });
          const result = await response.json();

          if (response.ok) {
            await fetchAnime();
          } else {
            alert(`Sync Error: ${result.detail}`);
          }
        } catch (error) {
          alert("Failed to connect to the backend sync service.");
          console.error(error);
        } finally {
          icon.classList.remove("fa-spin");
          btn.classList.remove("opacity-75");
          btn.innerText = " Sync Sheets";
          btn.prepend(icon);
        }
      }

      // Initialize the app on page load
      document.addEventListener("DOMContentLoaded", () => {
        fetchAnime();
      });
    </script>
  </body>
</html>
