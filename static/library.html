<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Library - CG1618 Anime Site</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Roboto", "Noto Sans TC", "sans-serif"] },
            colors: { brand: { DEFAULT: "#6366f1", hover: "#4f46e5" } },
          },
        },
      };
    </script>
    <style>
      /* Custom scrollbar for a clean spreadsheet feel */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f3f4f6;
      }
      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      .sortable:hover {
        cursor: pointer;
        background-color: #f9fafb;
      }

      /* Hide number input arrows for a cleaner spreadsheet look */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col font-sans">
    <!-- Top Navigation Bar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo & Links -->
          <div class="flex items-center space-x-8">
            <div
              class="flex-shrink-0 font-bold text-2xl tracking-wider text-brand"
            >
              CG1618
            </div>
            <div class="hidden md:block">
              <div class="flex items-baseline space-x-4">
                <a
                  href="/"
                  class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium transition"
                  >Dashboard</a
                >
                <a
                  href="/library"
                  class="bg-gray-100 text-gray-900 px-3 py-2 rounded-md text-sm font-medium"
                  >Library</a
                >
                <a
                  href="/admin"
                  class="text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium transition"
                  >Admin</a
                >
              </div>
            </div>
          </div>

          <!-- Search & Sync -->
          <div class="flex items-center space-x-4 flex-1 justify-end">
            <div class="relative w-full max-w-md hidden sm:block">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-search text-gray-400"></i>
              </div>
              <input
                type="text"
                id="searchInput"
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-brand focus:border-brand sm:text-sm transition"
                placeholder="Search Title, Alt Name, Studio..."
              />
            </div>

            <button
              onclick="handleSync()"
              id="syncBtn"
              class="bg-brand hover:bg-brand-hover text-white px-4 py-2 rounded-md text-sm font-medium flex items-center transition shadow-sm"
            >
              <i class="fas fa-sync-alt mr-2" id="syncIcon"></i> Sync Sheets
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content: Spreadsheet Table -->
    <main
      class="flex-1 w-full max-w-[100vw] px-4 py-6 flex flex-col h-[calc(100vh-4rem)]"
    >
      <!-- Toolbar above the table -->
      <div class="mb-4 flex justify-end items-center shrink-0">
        <button
          onclick="toggleAll()"
          id="toggleAllBtn"
          class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-3 py-1.5 rounded-md text-sm font-medium transition shadow-sm flex items-center"
        >
          <i class="fas fa-compress-arrows-alt mr-2"></i> Collapse All
        </button>
      </div>

      <!-- Scrollable Table Container -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 flex-1 overflow-hidden flex flex-col min-h-0"
      >
        <div class="overflow-auto flex-1 relative">
          <table class="w-full text-sm text-left whitespace-nowrap">
            <thead class="text-xs text-gray-600 uppercase">
              <tr>
                <!-- Sticky applied directly to <th> elements to guarantee it works -->
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb] sortable transition"
                  onclick="handleSort('title')"
                >
                  Title <i class="fas fa-sort text-gray-400 ml-1"></i>
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Season
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb] sortable transition"
                  onclick="handleSort('rating_mine')"
                >
                  Rating <i class="fas fa-sort text-gray-400 ml-1"></i>
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb] sortable transition"
                  onclick="handleSort('my_progress')"
                >
                  Status <i class="fas fa-sort text-gray-400 ml-1"></i>
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Airing
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Episodes
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Type
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Class
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb] sortable transition"
                  onclick="handleSort('release_date')"
                >
                  Release <i class="fas fa-sort text-gray-400 ml-1"></i>
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Studio
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Director
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  Distributor
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb]"
                >
                  巴哈
                </th>
                <th
                  scope="col"
                  class="px-4 py-3 sticky top-0 z-40 bg-gray-50 shadow-[0_1px_0_0_#e5e7eb] max-w-[200px]"
                >
                  Notes
                </th>
              </tr>
            </thead>
            <tbody id="libraryTableBody" class="divide-y divide-gray-200">
              <!-- Rows injected via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      const API_BASE_URL = "/api";
      let originalData = [];
      let displayData = [];
      let sortCol = "";
      let sortAsc = true;

      // NEW: State variables to track collapsed series and ratings
      let collapsedSeries = new Set();
      let isAllCollapsed = false;
      let seriesMetadata = {};

      // Fetch data on load
      async function fetchLibrary() {
        try {
          // Fetch both anime entries and series metadata concurrently
          const [animeRes, seriesRes] = await Promise.all([
            fetch(`${API_BASE_URL}/anime`),
            fetch(`${API_BASE_URL}/series`),
          ]);

          originalData = await animeRes.json();

          // Map series metadata for quick lookup
          const seriesData = await seriesRes.json();
          seriesData.forEach((s) => {
            if (s.series_en) seriesMetadata[s.series_en] = s;
          });

          displayData = [...originalData];
          renderTable();
        } catch (error) {
          console.error("Failed to load library data:", error);
        }
      }

      // Get robust main title
      function getDisplayTitle(anime) {
        let mainTitle = anime.series_season_cn;
        if (!mainTitle) {
          mainTitle =
            anime.series_season_en || anime.series_en || "Unknown Title";
        }
        return mainTitle;
      }

      // Render Table Rows (Grouped by series_en)
      function renderTable() {
        const tbody = document.getElementById("libraryTableBody");
        tbody.innerHTML = "";

        // 1. Group Data by series_en
        const groupedData = {};
        displayData.forEach((anime) => {
          // Group by series_en, or label as standalone
          const seriesName = anime.series_en || "Standalone / Other";
          if (!groupedData[seriesName]) {
            groupedData[seriesName] = [];
          }
          groupedData[seriesName].push(anime);
        });

        // 2. Sort Series Groups (Alphabetically)
        let seriesNames = Object.keys(groupedData);
        seriesNames.sort((a, b) => {
          const metaA = seriesMetadata[a] || {};
          const metaB = seriesMetadata[b] || {};
          const entriesA = groupedData[a] || [];
          const entriesB = groupedData[b] || [];

          let valA = a;
          let valB = b;

          // Sort the overarching Series logic based on the selected column
          if (sortCol === "rating_mine") {
            valA = metaA.rating_series || "";
            valB = metaB.rating_series || "";
            const tiers = { S: 1, "A+": 2, A: 3, B: 4, C: 5, D: 6, E: 7, F: 8 };
            valA = tiers[valA] || 99;
            valB = tiers[valB] || 99;
          } else if (sortCol === "release_date") {
            valA = entriesA[0]?.release_date || "";
            valB = entriesB[0]?.release_date || "";
          } else if (sortCol === "my_progress") {
            valA = entriesA[0]?.my_progress || "";
            valB = entriesB[0]?.my_progress || "";
          }

          if (valA < valB) return sortAsc ? -1 : 1;
          if (valA > valB) return sortAsc ? 1 : -1;
          return 0;
        });

        // 3. Render Groups and their Items
        seriesNames.forEach((seriesName) => {
          const meta = seriesMetadata[seriesName] || {};
          const isCollapsed = collapsedSeries.has(seriesName);
          const chevronClass = isCollapsed
            ? "fa-chevron-right text-gray-400"
            : "fa-chevron-down text-gray-600";

          // Format the Series Rating Badge
          let seriesRatingBadge = "";
          const sRating = meta.rating_series;
          if (sRating) {
            let sRatingColor = "text-gray-600 border-gray-300 bg-white";
            if (["S", "A+", "A"].includes(sRating))
              sRatingColor = "text-red-700 border-red-200 bg-red-50";
            else if (["B", "C"].includes(sRating))
              sRatingColor = "text-blue-700 border-blue-200 bg-blue-50";

            seriesRatingBadge = `<span class="px-2 py-0.5 text-[10px] uppercase tracking-wider rounded border ${sRatingColor} font-bold ml-3 shadow-sm">Overall: ${sRating}</span>`;
          }

          // Format Series Title display (Chinese Name Left, English Name Right, Alt Name End)
          const cnName = meta.series_cn || "";
          const enName = seriesName !== "Standalone / Other" ? seriesName : "";
          const altName = meta.alt_name || "";

          let titleDisplay = "";
          if (cnName && enName) {
            titleDisplay = `<span class="text-gray-900">${cnName}</span><span class="text-gray-500 font-normal ml-2">${enName}</span>`;
          } else if (cnName) {
            titleDisplay = `<span class="text-gray-900">${cnName}</span>`;
          } else if (enName) {
            titleDisplay = `<span class="text-gray-900">${enName}</span>`;
          } else {
            titleDisplay = `<span class="text-gray-900">Standalone / Other</span>`;
          }

          // Use ml-auto to push the Alt Name beautifully to the right edge
          let altNameDisplay = altName
            ? `<span class="text-xs text-gray-400 font-normal ml-auto italic pr-4 pl-4">${altName}</span>`
            : "";

          // Render Group Header Row (Now Clickable)
          const headerTr = document.createElement("tr");
          headerTr.className =
            "bg-gray-100/80 border-y border-gray-200 cursor-pointer hover:bg-gray-200/80 transition-colors";
          headerTr.onclick = () => toggleSeries(seriesName);
          headerTr.innerHTML = `
                    <td colspan="14" class="px-4 py-3 font-bold text-gray-800 text-sm select-none">
                        <div class="flex items-center w-full">
                            <i class="fas ${chevronClass} w-4 text-center mr-1"></i>
                            <i class="fas fa-layer-group text-brand mr-2"></i>
                            ${titleDisplay}
                            ${seriesRatingBadge}
                            ${altNameDisplay}
                        </div>
                    </td>
                `;
          tbody.appendChild(headerTr);

          // If this series is collapsed, skip rendering its children!
          if (isCollapsed) return;

          // 4. Sort Items inside the group (Always chronological by season)
          const animesInSeries = groupedData[seriesName];
          animesInSeries.sort((a, b) => {
            let valA = a.series_season_en || a.series_en || "";
            let valB = b.series_season_en || b.series_en || "";
            return valA.localeCompare(valB, undefined, {
              numeric: true,
              sensitivity: "base",
            });
          });

          // 5. Render Individual Anime Rows
          animesInSeries.forEach((anime) => {
            const title = getDisplayTitle(anime);
            const rating = anime.rating_mine || "-";
            const status = anime.my_progress || "-";

            const epFin = anime.ep_fin || 0;
            const epTotal = anime.ep_total || "?";

            // Create a clickable, editable number input for episodes
            const epsInput = `
                        <div class="flex items-center">
                            <input type="number" value="${epFin}" min="0" ${anime.ep_total ? `max="${anime.ep_total}"` : ""}
                                   onchange="updateEpisode('${anime.system_id}', this.value, ${epFin})"
                                   class="w-8 bg-transparent border-b border-dashed border-gray-400 hover:border-brand focus:border-solid focus:border-brand focus:outline-none text-center font-mono py-0.5 transition-colors"
                                   onclick="this.select()">
                            <span class="text-gray-500 font-mono ml-1">/ ${epTotal}</span>
                        </div>
                    `;

            const bahaStr = String(anime.source_baha || "").toUpperCase();
            const bahaDisplay = bahaStr === "TRUE" ? "有" : "無";
            const bahaColor =
              bahaDisplay === "有"
                ? "text-green-600 font-bold"
                : "text-gray-400";

            let statusColor = "text-gray-600 bg-gray-100";
            if (status === "Active Watching")
              statusColor = "text-green-700 bg-green-100";
            if (status === "Passive Watching")
              statusColor = "text-blue-700 bg-blue-100";
            if (status === "Paused")
              statusColor = "text-orange-700 bg-orange-100";
            if (status === "Completed")
              statusColor = "text-purple-700 bg-purple-100";

            let ratingColor = "text-gray-600";
            if (["S", "A+", "A"].includes(rating))
              ratingColor = "text-red-600 font-bold";
            else if (["B", "C"].includes(rating))
              ratingColor = "text-blue-600 font-medium";

            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 transition-colors";
            tr.innerHTML = `
                        <td class="px-4 py-3 pl-10 font-medium text-gray-900 max-w-[250px] truncate" title="${title}">
                            ${title}
                        </td>
                        <td class="px-4 py-3 text-gray-600 font-medium whitespace-nowrap">${anime.series_season || "-"}</td>
                        <td class="px-4 py-3 ${ratingColor}">${rating}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-md ${statusColor}">${status}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-500">${anime.airing_status || "-"}</td>
                        <td class="px-4 py-3 text-xs">${epsInput}</td>
                        <td class="px-4 py-3 text-gray-500">${anime.airing_type || "-"}</td>
                        <td class="px-4 py-3 text-gray-500">${anime.main_spinoff || "-"}</td>
                        <td class="px-4 py-3 text-gray-900">${anime.release_date || "-"}</td>
                        <td class="px-4 py-3 text-gray-500 max-w-[150px] truncate" title="${anime.studio || ""}">${anime.studio || "-"}</td>
                        <td class="px-4 py-3 text-gray-500 max-w-[150px] truncate" title="${anime.director || ""}">${anime.director || "-"}</td>
                        <td class="px-4 py-3 text-gray-500">${anime.distributor_tw || "-"}</td>
                        <td class="px-4 py-3 ${bahaColor}">${bahaDisplay}</td>
                        <td class="px-4 py-3 text-gray-400 max-w-[200px] truncate" title="${anime.remark || ""}">${anime.remark || "-"}</td>
                    `;
            tbody.appendChild(tr);
          });
        });
      }

      // NEW: Toggle a single series
      function toggleSeries(seriesName) {
        if (collapsedSeries.has(seriesName)) {
          collapsedSeries.delete(seriesName); // Expand
        } else {
          collapsedSeries.add(seriesName); // Collapse
        }
        renderTable();
      }

      // NEW: Send updated episode count directly to backend
      async function updateEpisode(systemId, newValue, oldValue) {
        const parsedValue = parseInt(newValue, 10);
        if (isNaN(parsedValue) || parsedValue < 0) {
          alert("Invalid episode number.");
          renderTable(); // Revert to old value
          return;
        }

        // Optimistically update the UI arrays
        const displayIndex = displayData.findIndex(
          (a) => a.system_id === systemId,
        );
        if (displayIndex !== -1) displayData[displayIndex].ep_fin = parsedValue;

        const origIndex = originalData.findIndex(
          (a) => a.system_id === systemId,
        );
        if (origIndex !== -1) originalData[origIndex].ep_fin = parsedValue;

        try {
          // Same endpoint used by the Dashboard's +/- buttons
          const response = await fetch(
            `${API_BASE_URL}/anime/${systemId}/progress`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ep_fin: parsedValue }),
            },
          );

          if (!response.ok) throw new Error("Server rejected update");
        } catch (error) {
          console.error("Error updating progress:", error);
          alert("Failed to sync progress to database. Check your connection.");

          // Revert on failure
          if (displayIndex !== -1) displayData[displayIndex].ep_fin = oldValue;
          if (origIndex !== -1) originalData[origIndex].ep_fin = oldValue;
          renderTable();
        }
      }

      // Handle Sorting (State update only)
      function handleSort(column) {
        if (sortCol === column) {
          sortAsc = !sortAsc; // Toggle direction
        } else {
          sortCol = column;
          sortAsc = true; // Default to ascending
        }
        renderTable();
      }

      // Handle Search Bar
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        displayData = originalData.filter((anime) => {
          const meta = anime.series_en
            ? seriesMetadata[anime.series_en] || {}
            : {};
          return (
            (anime.series_en &&
              anime.series_en.toLowerCase().includes(query)) ||
            (meta.series_cn && meta.series_cn.toLowerCase().includes(query)) ||
            (anime.series_season_en &&
              anime.series_season_en.toLowerCase().includes(query)) ||
            (anime.series_season_cn &&
              anime.series_season_cn.toLowerCase().includes(query)) ||
            (meta.alt_name && meta.alt_name.toLowerCase().includes(query)) ||
            (anime.studio && anime.studio.toLowerCase().includes(query))
          );
        });
        // Re-apply sort to filtered data
        if (sortCol) handleSort(sortCol);
        else renderTable();
      });

      // Handle Sync Button
      async function handleSync() {
        const icon = document.getElementById("syncIcon");
        const btn = document.getElementById("syncBtn");

        icon.classList.add("fa-spin");
        btn.classList.add("opacity-75");
        btn.innerText = " Syncing...";
        btn.prepend(icon);

        try {
          // Keep the exact same API route for the sync endpoint
          const response = await fetch(`${API_BASE_URL}/sync`, {
            method: "POST",
          });
          const result = await response.json();

          if (response.ok) {
            // Refresh the library table data!
            await fetchLibrary();
          } else {
            alert(`Sync Error: ${result.detail}`);
          }
        } catch (error) {
          alert("Failed to connect to the backend sync service.");
          console.error(error);
        } finally {
          icon.classList.remove("fa-spin");
          btn.classList.remove("opacity-75");
          btn.innerText = " Sync Sheets";
          btn.prepend(icon);
        }
      }

      document.addEventListener("DOMContentLoaded", fetchLibrary);
    </script>
  </body>
</html>
